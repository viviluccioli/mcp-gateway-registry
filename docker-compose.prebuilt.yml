version: '3.8'

# DocumentDB Initialization:
# For AWS DocumentDB Elastic Cluster setup, run the initialization script:
#   export DOCUMENTDB_HOST=your-cluster.docdb.amazonaws.com
#   export DOCUMENTDB_USERNAME=admin
#   export DOCUMENTDB_PASSWORD=yourpassword
#   ./scripts/init-documentdb.sh
#
# Then set STORAGE_BACKEND=documentdb in your environment and restart services.
# Note: DocumentDB is a managed AWS service and runs outside of Docker.

services:
  # Registry service (includes nginx, SSL, FAISS, models) - using pre-built image
  registry:
    image: ${DOCKERHUB_ORG:-mcpgateway}/registry:${REGISTRY_VERSION:-latest}
    environment:
      - BUILD_VERSION=${BUILD_VERSION:-1.0.0}
      - SECRET_KEY=${SECRET_KEY}
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - AUTH_SERVER_URL=${AUTH_SERVER_URL}
      - AUTH_SERVER_EXTERNAL_URL=${AUTH_SERVER_EXTERNAL_URL}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}
      - COGNITO_CLIENT_SECRET=${COGNITO_CLIENT_SECRET}
      - COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - HEALTH_CHECK_INTERVAL_SECONDS=${HEALTH_CHECK_INTERVAL_SECONDS:-30}
      - SRE_GATEWAY_AUTH_TOKEN=${SRE_GATEWAY_AUTH_TOKEN}
      - ATLASSIAN_AUTH_TOKEN=${ATLASSIAN_AUTH_TOKEN}
      # Metrics configuration
      - METRICS_SERVICE_URL=http://metrics-service:8890
      - METRICS_API_KEY=${METRICS_API_KEY_REGISTRY}
      - METRICS_API_KEY_NGINX=${METRICS_API_KEY_REGISTRY}
      # Keycloak configuration
      - AUTH_PROVIDER=${AUTH_PROVIDER:-cognito}
      - KEYCLOAK_ENABLED=${KEYCLOAK_ENABLED:-false}
      - KEYCLOAK_URL=${KEYCLOAK_URL:-http://keycloak:8080}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM:-mcp-gateway}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-mcp-gateway-web}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - KEYCLOAK_M2M_CLIENT_ID=${KEYCLOAK_M2M_CLIENT_ID}
      - KEYCLOAK_M2M_CLIENT_SECRET=${KEYCLOAK_M2M_CLIENT_SECRET}
      # External Registry Configuration
      - EXTERNAL_REGISTRY_TAGS=${EXTERNAL_REGISTRY_TAGS:-anthropic-registry,workday-asor}
      - ASOR_ACCESS_TOKEN=${ASOR_ACCESS_TOKEN}
      - ASOR_CLIENT_CREDENTIALS=${ASOR_CLIENT_CREDENTIALS}
      # Security Scanning Configuration
      - SECURITY_SCAN_ENABLED=${SECURITY_SCAN_ENABLED:-true}
      - SECURITY_SCAN_ON_REGISTRATION=${SECURITY_SCAN_ON_REGISTRATION:-true}
      - SECURITY_BLOCK_UNSAFE_SERVERS=${SECURITY_BLOCK_UNSAFE_SERVERS:-true}
      - SECURITY_ANALYZERS=${SECURITY_ANALYZERS:-yara}
      - SECURITY_SCAN_TIMEOUT=${SECURITY_SCAN_TIMEOUT:-60}
      - SECURITY_ADD_PENDING_TAG=${SECURITY_ADD_PENDING_TAG:-true}
      - MCP_SCANNER_LLM_API_KEY=${MCP_SCANNER_LLM_API_KEY}
      # Storage Backend Configuration
      - STORAGE_BACKEND=${STORAGE_BACKEND:-file}
      # DocumentDB/MongoDB Configuration (when STORAGE_BACKEND=documentdb)
      - DOCUMENTDB_HOST=${DOCUMENTDB_HOST:-mongodb}
      - DOCUMENTDB_PORT=${DOCUMENTDB_PORT:-27017}
      - DOCUMENTDB_USERNAME=${DOCUMENTDB_USERNAME}
      - DOCUMENTDB_PASSWORD=${DOCUMENTDB_PASSWORD}
      - DOCUMENTDB_DATABASE=${DOCUMENTDB_DATABASE:-mcp_registry}
      - DOCUMENTDB_NAMESPACE=${DOCUMENTDB_NAMESPACE:-default}
      - DOCUMENTDB_USE_TLS=${DOCUMENTDB_USE_TLS:-false}
      - DOCUMENTDB_TLS_CA_FILE=${DOCUMENTDB_TLS_CA_FILE:-}
      - DOCUMENTDB_USE_IAM=${DOCUMENTDB_USE_IAM:-false}
      - DOCUMENTDB_REPLICA_SET=${DOCUMENTDB_REPLICA_SET:-rs0}
      - DOCUMENTDB_READ_PREFERENCE=${DOCUMENTDB_READ_PREFERENCE:-secondaryPreferred}
      # Embeddings Configuration
      - EMBEDDINGS_PROVIDER=${EMBEDDINGS_PROVIDER:-sentence-transformers}
      - EMBEDDINGS_MODEL_NAME=${EMBEDDINGS_MODEL_NAME:-all-MiniLM-L6-v2}
      - EMBEDDINGS_MODEL_DIMENSIONS=${EMBEDDINGS_MODEL_DIMENSIONS:-384}
      - EMBEDDINGS_API_KEY=${EMBEDDINGS_API_KEY}
      - EMBEDDINGS_API_BASE=${EMBEDDINGS_API_BASE}
      - EMBEDDINGS_AWS_REGION=${EMBEDDINGS_AWS_REGION:-us-east-1}
    ports:
      - "80:80"
      - "443:443"
      - "7860:7860"
    volumes:
      - ${HOME}/mcp-gateway/servers:/app/registry/servers
      - ${HOME}/mcp-gateway/agents:/app/registry/agents
      - ${HOME}/mcp-gateway/models:/app/registry/models
      - ${HOME}/mcp-gateway/logs:/app/logs
      - ${HOME}/mcp-gateway/security_scans:/app/security_scans
      - ${HOME}/mcp-gateway/auth_server/scopes.yml:/app/auth_server/scopes.yml
      - ${HOME}/mcp-gateway/federation.json:/app/config/federation.json
      - ${HOME}/mcp-gateway/ssl:/etc/ssl:ro
    depends_on:
      - auth-server
      - metrics-service
    restart: unless-stopped

  # Metrics Collection Service - using pre-built image
  metrics-service:
    image: ${DOCKERHUB_ORG:-mcpgateway}/metrics-service:${METRICS_VERSION:-latest}
    environment:
      - METRICS_SERVICE_PORT=8890
      - METRICS_SERVICE_HOST=0.0.0.0
      - SQLITE_DB_PATH=/var/lib/sqlite/metrics.db
      - METRICS_RETENTION_DAYS=90
      - METRICS_API_KEY_AUTH=${METRICS_API_KEY_AUTH_SERVER}
      - METRICS_API_KEY_REGISTRY=${METRICS_API_KEY_REGISTRY}
      - METRICS_API_KEY_MCPGW=${METRICS_API_KEY_MCPGW_SERVER}
      - OTEL_SERVICE_NAME=mcp-metrics-service
      - OTEL_PROMETHEUS_ENABLED=true
      - OTEL_PROMETHEUS_PORT=9465
      - METRICS_RATE_LIMIT=1000
    ports:
      - "8890:8890"
      - "9465:9465"  # Prometheus metrics endpoint
    volumes:
      - metrics-db-data:/var/lib/sqlite
      - ${HOME}/mcp-gateway/logs:/app/logs
    depends_on:
      - metrics-db
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8890/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Auth service (separate and scalable) - using pre-built image
  auth-server:
    image: ${DOCKERHUB_ORG:-mcpgateway}/auth-server:${AUTH_SERVER_VERSION:-latest}
    environment:
      - REGISTRY_URL=${REGISTRY_URL}
      - SECRET_KEY=${SECRET_KEY}
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}
      - COGNITO_CLIENT_SECRET=${COGNITO_CLIENT_SECRET}
      - COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
      - COGNITO_DOMAIN=${COGNITO_DOMAIN:-auto}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      # Metrics configuration
      - METRICS_SERVICE_URL=http://metrics-service:8890
      - METRICS_API_KEY=${METRICS_API_KEY_AUTH_SERVER}
      # Keycloak configuration
      - AUTH_PROVIDER=${AUTH_PROVIDER:-cognito}  # 'cognito' or 'keycloak'
      - KEYCLOAK_ENABLED=${KEYCLOAK_ENABLED:-false}
      - KEYCLOAK_URL=${KEYCLOAK_URL:-http://keycloak:8080}
      - KEYCLOAK_EXTERNAL_URL=${KEYCLOAK_EXTERNAL_URL:-http://localhost:8080}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM:-mcp-gateway}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-mcp-gateway-web}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      - KEYCLOAK_M2M_CLIENT_ID=${KEYCLOAK_M2M_CLIENT_ID:-mcp-gateway-m2m}
      - KEYCLOAK_M2M_CLIENT_SECRET=${KEYCLOAK_M2M_CLIENT_SECRET}
      # Entra ID configuration
      - ENTRA_TENANT_ID=${ENTRA_TENANT_ID}
      - ENTRA_CLIENT_ID=${ENTRA_CLIENT_ID}
      - ENTRA_CLIENT_SECRET=${ENTRA_CLIENT_SECRET}
      - ENTRA_ENABLED=${ENTRA_ENABLED:-false}
      # Storage Backend Configuration
      - STORAGE_BACKEND=${STORAGE_BACKEND:-file}
      # DocumentDB/MongoDB Configuration (when STORAGE_BACKEND=documentdb or mongodb-ce)
      - DOCUMENTDB_HOST=${DOCUMENTDB_HOST:-mongodb}
      - DOCUMENTDB_PORT=${DOCUMENTDB_PORT:-27017}
      - DOCUMENTDB_USERNAME=${DOCUMENTDB_USERNAME}
      - DOCUMENTDB_PASSWORD=${DOCUMENTDB_PASSWORD}
      - DOCUMENTDB_DATABASE=${DOCUMENTDB_DATABASE:-mcp_registry}
      - DOCUMENTDB_NAMESPACE=${DOCUMENTDB_NAMESPACE:-default}
      - DOCUMENTDB_USE_TLS=${DOCUMENTDB_USE_TLS:-false}
      - DOCUMENTDB_TLS_CA_FILE=${DOCUMENTDB_TLS_CA_FILE}
      - DOCUMENTDB_USE_IAM=${DOCUMENTDB_USE_IAM:-false}
      - DOCUMENTDB_REPLICA_SET=${DOCUMENTDB_REPLICA_SET:-rs0}
      - DOCUMENTDB_READ_PREFERENCE=${DOCUMENTDB_READ_PREFERENCE:-secondaryPreferred}
    ports:
      - "8888:8888"
    volumes:
      - ${HOME}/mcp-gateway/logs:/app/logs
      # - ${HOME}/mcp-gateway/auth_server/scopes.yml:/app/scopes.yml
    depends_on:
      metrics-service:
        condition: service_healthy
    restart: unless-stopped

  # Current Time MCP Server - using pre-built image
  currenttime-server:
    image: ${DOCKERHUB_ORG:-mcpgateway}/currenttime-server:${CURRENTTIME_VERSION:-latest}
    environment:
      - PORT=8000
      - MCP_TRANSPORT=streamable-http
    ports:
      - "8000:8000"
    restart: unless-stopped

  # Financial Info MCP Server - using pre-built image
  fininfo-server:
    image: ${DOCKERHUB_ORG:-mcpgateway}/fininfo-server:${FININFO_VERSION:-latest}
    environment:
      - PORT=8001
      - SECRET_KEY=${SECRET_KEY}
    volumes:
      - ${HOME}/mcp-gateway/secrets/fininfo/:/app/fininfo/
    ports:
      - "8001:8001"
    restart: unless-stopped

  # MCP Gateway Server - using pre-built image
  mcpgw-server:
    image: ${DOCKERHUB_ORG:-mcpgateway}/mcpgw-server:${MCPGW_VERSION:-latest}
    environment:
      - PORT=8003
      - REGISTRY_BASE_URL=http://registry:7860
      - REGISTRY_USERNAME=${ADMIN_USER:-admin}
      - REGISTRY_PASSWORD=${ADMIN_PASSWORD}
    volumes:
      - ${HOME}/mcp-gateway/servers:/app/registry/servers
      - ${HOME}/mcp-gateway/models:/app/registry/models
      - ${HOME}/mcp-gateway/auth_server/scopes.yml:/app/auth_server/scopes.yml
    ports:
      - "8003:8003"
    depends_on:
      - registry
    restart: unless-stopped

  # Real Server Fake Tools MCP Server - using pre-built image
  realserverfaketools-server:
    image: ${DOCKERHUB_ORG:-mcpgateway}/realserverfaketools-server:${REALSERVERFAKETOOLS_VERSION:-latest}
    environment:
      - PORT=8002
    ports:
      - "8002:8002"
    restart: unless-stopped

  # Atlassian MCP Server - using mirrored pre-built image
  atlassian-server:
    image: ${DOCKERHUB_ORG:-mcpgateway}/atlassian:${ATLASSIAN_VERSION:-latest}
    environment:
      - ATLASSIAN_OAUTH_ENABLE=true
      - MCP_VERY_VERBOSE=true
      - MCP_LOGGING_STDOUT=true
    ports:
      - "8005:8005"
    volumes:
      - $HOME/.mcp-atlassian:/home/app/.mcp-atlassian
    command: --transport streamable-http --port 8005
    restart: unless-stopped

  # SQLite container for metrics database - using mirrored pre-built image
  metrics-db:
    image: ${DOCKERHUB_ORG:-mcpgateway}/alpine:${ALPINE_VERSION:-latest}
    volumes:
      - metrics-db-data:/var/lib/sqlite
    command: ["sh", "-c", "apk add --no-cache sqlite && mkdir -p /var/lib/sqlite && sqlite3 /var/lib/sqlite/metrics.db 'CREATE TABLE IF NOT EXISTS _health (id INTEGER);' && tail -f /dev/null"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sqlite3", "/var/lib/sqlite/metrics.db", ".tables"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Prometheus for metrics collection - using mirrored pre-built image
  prometheus:
    image: ${DOCKERHUB_ORG:-mcpgateway}/prometheus:${PROMETHEUS_VERSION:-latest}
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped

  # Grafana for metrics visualization - using mirrored pre-built image
  grafana:
    image: ${DOCKERHUB_ORG:-mcpgateway}/grafana:${GRAFANA_VERSION:-latest}
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./config/grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    restart: unless-stopped

  # PostgreSQL database for Keycloak - using mirrored pre-built image
  keycloak-db:
    image: ${DOCKERHUB_ORG:-mcpgateway}/postgres:${POSTGRES_VERSION:-latest}
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Keycloak Identity Provider - using mirrored pre-built image
  keycloak:
    image: ${DOCKERHUB_ORG:-mcpgateway}/keycloak:${KEYCLOAK_VERSION:-latest}
    command: start-dev  # Use 'start' for production with proper SSL
    environment:
      # Database configuration
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}

      # Admin credentials
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}

      # HTTP configuration
      KC_HTTP_ENABLED: 'true'
      KC_HTTP_PORT: 8080
      KC_HOSTNAME_STRICT: 'false'
      KC_HOSTNAME_STRICT_HTTPS: 'false'
      KC_PROXY: edge  # Running behind nginx

      # Frontend URL for external JWT issuer
      KC_FRONTEND_URL: ${KEYCLOAK_EXTERNAL_URL:-http://localhost:8080}

      # Features
      KC_FEATURES: token-exchange,admin-api

      # Logging
      KC_LOG_LEVEL: INFO

    ports:
      - "8080:8080"
    depends_on:
      keycloak-db:
        condition: service_healthy
    volumes:
      - ./keycloak/themes:/opt/keycloak/themes
      - ./keycloak/providers:/opt/keycloak/providers
      - ./keycloak/import:/opt/keycloak/data/import
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # MongoDB Community Edition 8.2 (alternative to DocumentDB for local development)
  # Vector search is implemented in application code (see search_repository.py)
  # Running without authentication for local development simplicity
  mongodb:
    image: mongo:8.2
    container_name: mcp-mongodb
    command: mongod --replSet rs0 --bind_ip 127.0.0.1,mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 60s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  # MongoDB initialization (creates replica set, indexes, and loads scopes)
  mongodb-init:
    image: python:3.11-slim
    container_name: mcp-mongodb-init
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      - DOCUMENTDB_HOST=mongodb
      - DOCUMENTDB_PORT=27017
      - DOCUMENTDB_DATABASE=${DOCUMENTDB_DATABASE:-mcp_registry}
      - DOCUMENTDB_NAMESPACE=${DOCUMENTDB_NAMESPACE:-default}
      - SCOPES_FILE=/app/config/scopes.yml
    volumes:
      - ./scripts/init-mongodb-ce.py:/app/init-mongodb-ce.py:ro
      - ./auth_server/scopes.yml:/app/config/scopes.yml:ro
    command: >
      sh -c "
      pip install --quiet motor pymongo pyyaml &&
      python /app/init-mongodb-ce.py
      "
    restart: "no"

volumes:
  ssl_data:
  keycloak_db_data:
  metrics-db-data:
  prometheus-data:
  grafana-data:
  mongodb-data:
  mongodb-config:
